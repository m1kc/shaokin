Шао-кин
=======

Я сегодня не выспался, поэтому мне захотелось перенести игру "Приключения Андрея Шапкина" на платформу Instead.


Генеральный план сражения
-------------------------

1. Написать спецификацию формата ТКР.
2. Написать парсер на CoffeeScript.
3. Написать (тоже на CS) транслятор в целевую платформу.
4. ???
5. Профит.


Всё решают спеки
----------------

Формат ТКР ~~абсолютно ебанутый~~ ~~довольно своеобразен~~ абсолютно ебанутый.

Основная единица игры - комната. Каждая комната хранится в отдельном файле с именем Room_X_.txt. Кроме того, существует специальная комната Room0, содержимое которой включается во все остальные.

Также существуют специальные файлы.

* Author.txt, INTRO.TXT, KEYWORDS.TXT, MAIN.TXT, RULES.TXT - обычные текстовые файлы, могут быть отображены, но директив не содержат.
* HINTS.TXT - отвечает за выдачу подсказок на первой локации. Строка с цифрой - это условие (про них см. далее), все строки до следующего условия - текст подсказки.
* INVENT.TXT - похоже, содержит названия предметов в инвентаре. Формат пока непонятен, но предполагаю, что если все условия в первой строке выполнены, то в списке вещей отображается текст со второй строки.


### Условия

Самая жесть - это, конечно, условия. Условие задаётся цифрой. Если число положительное - это if, если отрицательное - if not. В начале игры все условия ложны. Алиасы назначать нельзя; что означает каждая цифра, должен помнить автор.

Всё это работает примерно так:

```
Т Есть ли у меня меч?
Л -5
Нет, у вас нет меча.

Т Есть ли у меня меч?
Л 5
Да, есть, есть.
```


### Комнаты

* `<ключ> = <значение1>, <значение2>, <значение3>...`

Алиас. Указывает интерпретатору, что вместо ключа игрок может использовать любое из значений. Кстати, несколько алиасов в одной команде - вполне нормальная ситуация.

* `Т <команда>`

Если игрок ввёл команду, вывести на экран весь текст до следующей директивы. Если в команде есть знак процента `%`, то там может быть любая последовательность символов (к слову, он может быть и в середине строки). И ещё, кажется, слова можно вводить в любом порядке. Между `Т` и текстом могут идти условия `Л`: команда сработает только в случае, когда все `Л` выполняются. Между `Т` и текстом могут идти сеты `Д`: когда команда срабатывает, все сеты для неё тоже срабатывают. Между `Т` и текстом могут идти сеты `СС` и `СТ`: когда команда срабатывает, сет тоже срабатывает. Вместо текста или после него может быть `ИД`: когда команда срабатывает, `ИД` выполняется.

* `Л <условие1> <условие2> <условие3>...`

Проверяет, срабатывают ли все заданные условия.

* `Д <условие1> <условие2> <условие3>...`

Делает все заданные условия истинными. Обратной операции вроде бы нет.

* `СС`

~~Призывает в комнату штурмовой отряд НСДАП~~ Даёт +1 к карме.

* `СТ`

Даёт -1 к карме и вечный позор.

* `РН <заголовок>`

Задаёт заголовок окна.

* `РНМ <цифра>`

Э-э-э... Кажется, задаёт номер комнаты. Кажется, игнорируется к хуям.

* `ОП`

Задаёт описание комнаты - весь текст до следующей директивы.

* `ОП <условие1> <условие2> <условие3>...`

Замещает описание комнаты - весь текст до следующей директивы - если все условия выполняются.

* `ИД <номер>`

Перекидывает игрока в комнату с заданным номером.


#### Диалоги

* `ДИАЛ <текст>`

Эм... Как-то хуй пойми. Короче, похоже, что `ДИАЛ` - это одновременно и директива, и команда, и само слово `ДИАЛ` при этом может быть ключом для алиаса. Но как бы то ни было, оно включает режим обработки директив диалога.

* `КДИАЛ`

Отключает режим обработки директив диалога.

* `ДИ <цифра>`

Создаёт реплику. Цифра, кажется, игнорируется. Первая строка - что скажет игрок, остальные - что ему ответят. Между `ДИ` и текстом могут идти условия `Л`: реплика отображается только в случае, когда все `Л` выполняются. Между `ДИ` и текстом могут идти сеты `Д`: когда игрок произносит реплику, все сеты срабатывают. Ещё - не уверен, но вроде бы после произнесения реплика исчезает, и если реплик не осталось, диалог завершается.
